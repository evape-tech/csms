# CSMS Next.js å°ˆæ¡ˆ

é€™æ˜¯ä¸€å€‹åŸºæ–¼ [Next.js](https://nextjs.org) çš„å……é›»ç«™ç®¡ç†ç³»çµ± (CSMS) å°ˆæ¡ˆï¼Œæ¡ç”¨ç¾ä»£åŒ–å¾®æœå‹™æ¶æ§‹ï¼Œçµåˆäº†å‰ç«¯ä½¿ç”¨è€…ä»‹é¢ã€å¾Œç«¯ API æœå‹™ä»¥åŠ OCPP (Open Charge Point Protocol) ä¼ºæœå™¨ï¼Œä¸¦å…§å»ºäº†æ™ºèƒ½èƒ½æºç®¡ç†ç³»çµ± (EMS)ã€‚

## ğŸš€ å°ˆæ¡ˆç‰¹è‰²

-   **Next.js 15 å‰ç«¯**: æä¾›éŸ¿æ‡‰å¼ä¸”é«˜æ•ˆèƒ½çš„ä½¿ç”¨è€…ä»‹é¢ï¼Œæ¡ç”¨ App Router æ¶æ§‹é€²è¡Œå……é›»ç«™ç›£æ§å’Œç®¡ç†ã€‚
-   **OCPP 1.6 å”è­°**: å®Œæ•´å¯¦ç¾ OCPP å”è­°ï¼Œæ”¯æ´ WebSocket é›™å‘é€šè¨Šå’Œå¤šç¨®æ¶ˆæ¯é¡å‹è™•ç†ã€‚
-   **æ™ºèƒ½èƒ½æºç®¡ç†ç³»çµ± (EMS)**: 
    - ğŸ”„ **ä¸‰ç¨®è§¸ç™¼æ©Ÿåˆ¶**: æ‰‹å‹•è§¸ç™¼ã€å®šæ™‚æ ¡æ­£ã€äº‹ä»¶é©…å‹•
    - âš¡ **æ™ºèƒ½åŠŸç‡åˆ†é…**: æ”¯æ´éœæ…‹å’Œå‹•æ…‹åˆ†é…æ¨¡å¼ï¼Œé›»è¡¨ç´šç²¾ç´°åŒ–ç®¡ç†
    - ğŸ¯ **å³æ™‚éŸ¿æ‡‰**: æ¯«ç§’ç´šçš„å……é›»ç‹€æ…‹è®ŠåŒ–éŸ¿æ‡‰
    - ğŸ“Š **å¤šå±¤æ¶æ§‹**: å ´åŸŸ â†’ é›»è¡¨ â†’ å……é›»æ¨çš„éšå±¤å¼åŠŸç‡ç®¡ç†
-   **è‡ªå‹•è¨ˆè²»ç³»çµ±**: 
    - ğŸ’° **æ™ºèƒ½è¨ˆè²»**: äº¤æ˜“å®Œæˆæ™‚è‡ªå‹•ç”Ÿæˆbillingè¨˜éŒ„ï¼Œæ”¯æ´å¤šç¨®è²»ç‡æ–¹æ¡ˆ
    - ğŸ”„ **å­¤å…’äº¤æ˜“è™•ç†**: è‡ªå‹•è™•ç†ç•°å¸¸ä¸­æ–·çš„äº¤æ˜“ä¸¦ç”Ÿæˆå°æ‡‰è¨ˆè²»
    - ğŸ›¡ï¸ **é˜²é‡è¤‡æ©Ÿåˆ¶**: ç¢ºä¿æ¯ç­†äº¤æ˜“åªè¨ˆè²»ä¸€æ¬¡
    - ğŸ“Š **å¤šè²»ç‡æ”¯æ´**: å›ºå®šè²»ç‡ã€åˆ†æ™‚è²»ç‡ã€ç´¯é€²è²»ç‡ç­‰å¤šç¨®è¨ˆè²»æ¨¡å¼
-   **å¤šè³‡æ–™åº«æ”¯æ´**: æ”¯æ´ MSSQL å’Œ MySQLï¼Œä½¿ç”¨ Prisma ORM é€²è¡Œçµ±ä¸€ç®¡ç†å’Œè‡ªå‹•ç”Ÿæˆå®¢æˆ¶ç«¯ã€‚
-   **å®Œæ•´çš„ç”¨æˆ¶ç®¡ç†**: ç®¡ç†å“¡èˆ‡ä¸€èˆ¬ç”¨æˆ¶åˆ†é›¢ã€RFID å¡ç‰‡ç®¡ç†ã€éŒ¢åŒ…ç³»çµ±ã€æ“ä½œæ—¥èªŒè¿½è¹¤ã€‚
-   **RESTful API**: å®Œæ•´çš„ API æœå‹™ï¼Œæ¶µè“‹å……é›»æ¨ç®¡ç†ã€ä½¿ç”¨è€…èªè­‰ã€æ”¯ä»˜è™•ç†ã€æ•…éšœå ±å‘Šã€è¨ˆè²»ç®¡ç†ç­‰æ¨¡çµ„ã€‚
-   **å¯¦æ™‚ç›£æ§**: WebSocket é€£æ¥ç›£æ§ã€ç³»çµ±ç‹€æ…‹è¿½è¹¤å’Œæ•ˆèƒ½åˆ†æã€‚
-   **äº‹ä»¶é©…å‹•æ¶æ§‹ (é€²è¡Œä¸­)**: RabbitMQ æ¶ˆæ¯éšŠåˆ—åŸºç¤æ¶æ§‹å·²å»ºç«‹ï¼Œæ­£åœ¨é€æ­¥æ•´åˆè‡³å„æ¥­å‹™æ¨¡çµ„ã€‚

## ğŸ› ï¸ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¦æ±‚

-   **Node.js** (v18+ æ¨è–¦)
-   **npm** æˆ– **Yarn** åŒ…ç®¡ç†å™¨
-   **è³‡æ–™åº«**: MySQL 8.0+ æˆ– MSSQL Server 2019+
-   **RabbitMQ** (å¯é¸ï¼Œç”¨æ–¼äº‹ä»¶é©…å‹•æ¶æ§‹ï¼Œç›®å‰ç‚ºåˆæ­¥æ¥å…¥éšæ®µ)
-   **Git** ç‰ˆæœ¬æ§åˆ¶

## âš¡ EMS èƒ½æºç®¡ç†ç³»çµ±

### ä¸‰ç¨®åŠŸç‡æ›´æ–°æ©Ÿåˆ¶

1. **æ‰‹å‹•è§¸ç™¼ (Manual)**
   ```bash
   # æ‰‹å‹•è§¸ç™¼å…¨ç«™åŠŸç‡é‡æ–°åˆ†é…
   curl -X POST http://localhost:8089/ocpp/api/trigger_profile_update \
        -H "Content-Type: application/json" \
        -d '{"source":"manual_trigger"}'
   ```

2. **å®šæ™‚æ ¡æ­£ (Scheduled)**
   - æ¯ 60 ç§’è‡ªå‹•åŸ·è¡ŒåŠŸç‡æ ¡æ­£
   - å®¹éŒ¯è£œå„Ÿæ©Ÿåˆ¶ï¼Œç¢ºä¿ç³»çµ±ç©©å®šæ€§
   - å¯é€éç’°å¢ƒè®Šæ•¸èª¿æ•´é–“éš”

3. **äº‹ä»¶é©…å‹• (Event-driven)**
   - å³æ™‚éŸ¿æ‡‰ OCPP äº‹ä»¶ (StatusNotification, StartTransaction, StopTransaction)
   - æ¯«ç§’ç´šéŸ¿æ‡‰å……é›»ç‹€æ…‹è®ŠåŒ–
   - åŸºæ–¼æ¶ˆæ¯éšŠåˆ—çš„éé˜»å¡è™•ç†

### EMS æ¶æ§‹ç‰¹é»

- **ğŸ”„ äº‹ä»¶é©…å‹•**: ä½¿ç”¨ EventEmitter è§£æ±ºå¾ªç’°ä¾è³´
- **ğŸ“Š æ™ºèƒ½åˆ†é…**: åŸºæ–¼å ´åŸŸç¸½åŠŸç‡å’Œå……é›»æ¨ç‹€æ…‹çš„å‹•æ…‹åˆ†é…
- **ğŸš€ é«˜æ€§èƒ½**: æ”¯æ´å»¶è¿Ÿæ’ç¨‹å’Œæ‰¹é‡è™•ç†
- **ğŸ›¡ï¸ å®¹éŒ¯æ©Ÿåˆ¶**: å®šæ™‚æ ¡æ­£ç¢ºä¿ç³»çµ±ä¸€è‡´æ€§

### 1. å®‰è£ä¾è³´

é¦–å…ˆï¼Œè¤‡è£½å°ˆæ¡ˆä¸¦å®‰è£æ‰€æœ‰ä¾è³´ï¼š

```bash
git clone <ä½ çš„å°ˆæ¡ˆ Git URL>
cd csms-nextjs
npm install
# æˆ–è€…ä½¿ç”¨ yarn
# yarn install
```

### 2. ç’°å¢ƒè®Šæ•¸è¨­å®š

å»ºç«‹ä¸€å€‹ `.env` æª”æ¡ˆåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œä¸¦é…ç½®å¿…è¦çš„ç’°å¢ƒè®Šæ•¸ã€‚è«‹åƒè€ƒ `.env.example` æˆ–ä»¥ä¸‹ç¯„ä¾‹ï¼š

```env
# Next.js ç’°å¢ƒè®Šæ•¸
NEXT_PUBLIC_API_URL=http://localhost:3000/api

# è³‡æ–™åº«è¨­å®š (æ ¹æ“šä½ çš„è³‡æ–™åº«é¡å‹é¸æ“‡)
DATABASE_URL="mysql://user:password@localhost:3306/csms_db"
# æˆ– MSSQL
DATABASE_URL_MSSQL="sqlserver://localhost:1433;database=csms_db;user=user;password=password;encrypt=true;trustServerCertificate=true"
DB_PROVIDER="mysql" # æˆ– "mssql"

# OCPP ä¼ºæœå™¨è¨­å®š
OCPP_SERVER_PORT=8089
OCPP_NOTIFY_URL=http://localhost:8089/api/v1
OCPP_API_KEY=cp_api_key16888

# EMS ç³»çµ±è¨­å®š
EMS_RECONCILE_INTERVAL=60000  # å®šæ™‚æ ¡æ­£é–“éš”(æ¯«ç§’)
EMS_MODE=dynamic              # åˆ†é…æ¨¡å¼: static/dynamic

# RabbitMQ æ¶ˆæ¯éšŠåˆ—è¨­å®š (å¯é¸ - ç›®å‰ç‚ºåˆæ­¥é›†æˆéšæ®µ)
MQ_ENABLED=false              # æ˜¯å¦å•Ÿç”¨MQï¼Œå»ºè­°é–‹ç™¼éšæ®µè¨­ç‚ºfalse
MQ_HOST=127.0.0.1
MQ_PORT=5672
MQ_USERNAME=guest
MQ_PASSWORD=guest
MQ_VHOST=/

# Firebase è¨­å®š (å¦‚æœä½¿ç”¨)
FIREBASE_API_KEY="..."
FIREBASE_AUTH_DOMAIN="..."
# ... å…¶ä»– Firebase è®Šæ•¸
```

### 3. è³‡æ–™åº«è¨­å®šèˆ‡é·ç§»

å°ˆæ¡ˆæ”¯æ´ MySQL å’Œ MSSQL é›™è³‡æ–™åº«æ¶æ§‹ï¼Œæ ¹æ“šä½ çš„ `DB_PROVIDER` è¨­å®šé€²è¡Œç›¸æ‡‰çš„è³‡æ–™åº«æ“ä½œï¼š

```bash
# ç”Ÿæˆ Prisma å®¢æˆ¶ç«¯ (å…©å€‹è³‡æ–™åº«éƒ½æœƒç”Ÿæˆ)
npm run db:generate

# MySQL è³‡æ–™åº«é·ç§»
npm run db:migrate:mysql

# MSSQL è³‡æ–™åº«é·ç§»  
npm run db:migrate:mssql

# æˆ–ä½¿ç”¨ push æ¨¡å¼é€²è¡Œé–‹ç™¼
npm run db:push:mysql    # MySQL
npm run db:push:mssql    # MSSQL

# åˆå§‹åŒ–è³‡æ–™åº«å’ŒåŸºç¤è³‡æ–™
npm run db:init
```

### 4. é‹è¡Œå°ˆæ¡ˆ

å°ˆæ¡ˆæ¡ç”¨å¾®æœå‹™æ¶æ§‹ï¼ŒåŒ…å« Next.js å‰ç«¯/API å’Œ OCPP ä¼ºæœå™¨å…©å€‹ä¸»è¦æœå‹™ã€‚

#### ğŸŒ å•Ÿå‹• Next.js é–‹ç™¼ä¼ºæœå™¨ (å‰ç«¯ + API)

```bash
npm run dev
# æˆ–ä½¿ç”¨ Turbo æ¨¡å¼ (æ›´å¿«)
npm run dev:fast
```

é€™å°‡åœ¨ [http://localhost:3000](http://localhost:3000) å•Ÿå‹•å‰ç«¯æ‡‰ç”¨å’Œ Next.js API è·¯ç”±ã€‚

#### âš¡ å•Ÿå‹• OCPP ä¼ºæœå™¨ (å¾Œç«¯å¾®æœå‹™)

```bash
# ç”Ÿç”¢æ¨¡å¼
npm run start:ocpp

# é–‹ç™¼æ¨¡å¼ (æ”¯æ´ç†±é‡è¼‰)
npm run dev:ocpp

# åŒæ™‚å•Ÿå‹•å‰ç«¯å’Œ OCPP ä¼ºæœå™¨
npm run dev:all
```

OCPP ä¼ºæœå™¨å°‡åœ¨ [http://localhost:8089](http://localhost:8089) æä¾›ä»¥ä¸‹æœå‹™ï¼š
- WebSocket æœå‹™: `ws://localhost:8089/ocpp`
- REST API: `http://localhost:8089/api/v1`
- å¥åº·æª¢æŸ¥: `http://localhost:8089/health`
- ç³»çµ±ç‹€æ…‹: `http://localhost:8089/system/status`

#### ğŸ‡ RabbitMQ æœå‹™ (å¯é¸)

**æ³¨æ„**: RabbitMQ ç›®å‰ç‚ºåˆæ­¥æ¥å…¥éšæ®µï¼Œä¸»è¦æ¥­å‹™é‚è¼¯å°šæœªå®Œå…¨é·ç§»è‡³äº‹ä»¶é©…å‹•æ¨¡å¼ã€‚é–‹ç™¼éšæ®µå»ºè­°è¨­å®š `MQ_ENABLED=false`ã€‚

å¦‚éœ€å•Ÿç”¨ RabbitMQ é€²è¡Œæ¸¬è©¦ï¼š
```bash
# ä½¿ç”¨ Docker å•Ÿå‹• RabbitMQ (æ¨è–¦)
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management

# æˆ–ä½¿ç”¨æœ¬åœ°å®‰è£
rabbitmq-server

# ç®¡ç†ä»‹é¢ (å¦‚æœå•Ÿç”¨): http://localhost:15672 (guest/guest)
```

ç•¶å‰ MQ æ¶æ§‹ç‹€æ…‹ï¼š
- âœ… **åŸºç¤æ¶æ§‹**: å®Œæˆ RabbitMQ é€£æ¥ã€äº¤æ›æ©Ÿã€éšŠåˆ—è¨­å®š
- âœ… **äº‹ä»¶ç™¼å¸ƒè€…**: å¯¦ç¾ OCPP å’Œ EMS äº‹ä»¶ç™¼å¸ƒæ©Ÿåˆ¶  
- âœ… **äº‹ä»¶æ¶ˆè²»è€…**: å»ºç«‹æ¶ˆè²»è€…æ¡†æ¶å’Œæ¶ˆæ¯è™•ç†é‚è¼¯
- ğŸš§ **æ¥­å‹™æ•´åˆ**: æ­£åœ¨é€æ­¥å°‡æ ¸å¿ƒæ¥­å‹™é‚è¼¯é·ç§»è‡³äº‹ä»¶é©…å‹•æ¨¡å¼

## ğŸ“¡ API èªªæ˜

### Next.js API ç«¯é» (http://localhost:3000)

å°ˆæ¡ˆæä¾›ä»¥ä¸‹ä¸»è¦ API ç«¯é»ï¼š

#### ğŸ” èªè­‰èˆ‡ç”¨æˆ¶ç®¡ç†
-   `/api/login` - ä½¿ç”¨è€…ç™»å…¥
-   `/api/session` - æœƒè©±ç®¡ç†
-   `/api/users` - ç”¨æˆ¶ç®¡ç† (CRUD)
-   `/api/users/[id]/cards` - ç”¨æˆ¶ RFID å¡ç‰‡ç®¡ç†
-   `/api/users/[id]/wallet` - ç”¨æˆ¶éŒ¢åŒ…è³‡è¨Š
-   `/api/users/[id]/transactions` - ç”¨æˆ¶äº¤æ˜“è¨˜éŒ„

#### ğŸ’³ éŒ¢åŒ…èˆ‡å¡ç‰‡ç³»çµ±
-   `/api/wallet/topup` - éŒ¢åŒ…å„²å€¼
-   `/api/wallet/deduct` - éŒ¢åŒ…æ‰£æ¬¾
-   `/api/cards` - RFID å¡ç‰‡ç®¡ç†
-   `/api/cards/all` - æ‰€æœ‰å¡ç‰‡è³‡è¨Š

#### ğŸ’° è¨ˆè²»èˆ‡è²»ç‡
-   `/api/billing/channels` - è¨ˆè²»æ¸ é“ç®¡ç†
-   `/api/pricing_management` - è²»ç‡ç®¡ç†

#### ğŸ¢ å……é›»ç«™èˆ‡è¨­å‚™
-   `/api/stations` - å……é›»ç«™ç®¡ç†
-   `/api/charging_status` - å……é›»ç‹€æ…‹ç›£æ§
-   `/api/dashboard` - å„€è¡¨æ¿è³‡æ–™

#### ğŸ“Š ç³»çµ±ç®¡ç†
-   `/api/operation-logs` - æ“ä½œæ—¥èªŒ
-   `/api/database` - è³‡æ–™åº«ç®¡ç†
-   `/api/fault_report` - æ•…éšœå ±å‘Š
-   `/api/hardware_maintenance` - ç¡¬é«”ç¶­è­·
-   `/api/power_analysis` - åŠŸç‡åˆ†æ
-   `/api/reports` - å ±å‘Šç”Ÿæˆ

### OCPP API ç«¯é» (http://localhost:8089)

#### å¥åº·æª¢æŸ¥èˆ‡ç‹€æ…‹
- `GET /health` - æœå‹™å¥åº·æª¢æŸ¥
- `GET /system/status` - ç³»çµ±ç‹€æ…‹ç›£æ§
- `GET /mq/health` - æ¶ˆæ¯éšŠåˆ—å¥åº·ç‹€æ…‹

#### å……é›»æ¨ç®¡ç†
- `GET /api/v1/chargepoints/online` - ç²å–åœ¨ç·šå……é›»æ¨åˆ—è¡¨
- `POST /api/v1/chargepoints/:cpsn/remotestart` - é ç¨‹å•Ÿå‹•å……é›»
- `POST /api/v1/chargepoints/:cpsn/remotestop` - é ç¨‹åœæ­¢å……é›»
- `POST /api/v1/chargepoints/:cpsn/reset` - é‡å•Ÿå……é›»æ¨

#### EMS èƒ½æºç®¡ç†
- `POST /ocpp/api/trigger_profile_update` - æ‰‹å‹•è§¸ç™¼åŠŸç‡é‡æ–°åˆ†é…
- `POST /ocpp/api/trigger_meter_reallocation` - è§¸ç™¼é›»è¡¨ç´šåŠŸç‡é‡æ–°åˆ†é…
- `POST /ocpp/api/trigger_station_reallocation` - è§¸ç™¼ç«™é»ç´šåŠŸç‡é‡æ–°åˆ†é…
- `GET /ocpp/api/see_connections` - æŸ¥çœ‹ WebSocket é€£æ¥ç‹€æ…‹

è©³ç´°çš„ API æ–‡ä»¶è«‹åƒè€ƒå„å€‹ç«¯é»çš„å¯¦ç¾æˆ–ä½¿ç”¨å·¥å…·å¦‚ Postman é€²è¡Œæ¸¬è©¦ã€‚

## ğŸ§ª æ¸¬è©¦

å°ˆæ¡ˆåŒ…å«é‡å° EMS åˆ†é…æ¼”ç®—æ³•çš„å…¨é¢æ¸¬è©¦å¥—ä»¶ï¼Œæ”¯æ´å–®å…ƒæ¸¬è©¦ã€ä¸€è‡´æ€§æ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ã€‚

### é‹è¡Œ EMS ç›¸é—œæ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰ EMS æ¸¬è©¦ (æ¨è–¦)
scripts/run-ems-full-tests.bat

# æˆ–é‹è¡Œå–®å…ƒæ¸¬è©¦
scripts/run-ems-unit-tests.bat

# ä½¿ç”¨ Jest ç›´æ¥é‹è¡Œ
npm test tests/emsAllocator.test.js
npm test tests/emsConsistency.test.js  
npm test tests/emsIntegration.test.js
```

### æ¸¬è©¦é¡å‹

1. **å–®å…ƒæ¸¬è©¦** (`tests/emsAllocator.test.js`)
   - é©—è­‰ EMS åˆ†é…æ¼”ç®—æ³•çš„ç´”å‡½å¼é‚è¼¯
   - æ¸¬è©¦åŠŸç‡ç´„æŸã€å ´åŸŸé™åˆ¶ã€å……é›»æ¨è¦æ ¼ç­‰

2. **ä¸€è‡´æ€§æ¸¬è©¦** (`tests/emsConsistency.test.js`)
   - é©—è­‰æ–°èˆŠç³»çµ±é‚è¼¯ä¸€è‡´æ€§
   - ç¢ºä¿æ¶æ§‹é·ç§»å¾ŒåŠŸèƒ½æ­£ç¢ºæ€§

3. **æ•´åˆæ¸¬è©¦** (`tests/emsIntegration.test.js`)
   - é©—è­‰æ•´å€‹ EMS ç³»çµ±ç«¯åˆ°ç«¯åŠŸèƒ½
   - æ¸¬è©¦äº‹ä»¶é©…å‹•ã€API è§¸ç™¼ã€å®šæ™‚æ ¡æ­£ç­‰æ©Ÿåˆ¶

### æ¸¬è©¦å ±å‘Š

æ¸¬è©¦åŸ·è¡Œå¾Œæœƒç”Ÿæˆè©³ç´°å ±å‘Šæ–¼ `test-results/` ç›®éŒ„ï¼š
- æ¸¬è©¦è¦†è“‹ç‡çµ±è¨ˆ
- åŠŸç‡åˆ†é…é©—è­‰çµæœ  
- æ•ˆèƒ½åˆ†ææ•¸æ“š
- éŒ¯èª¤æ¡ˆä¾‹åˆ†æ

## ğŸ“š æ–‡ä»¶

-   **EMS æ¨¡å¼èªªæ˜**: `docs/EMS_MODE.md` - è©³ç´°èªªæ˜éœæ…‹/å‹•æ…‹æ¨¡å¼å·®ç•°
-   **EMS æ¸¬è©¦å ±å‘Š**: `test-results/` - æœ€æ–°çš„æ¸¬è©¦åŸ·è¡Œçµæœå’Œæ•ˆèƒ½åˆ†æ
-   **è¦†è“‹ç‡å ±å‘Š**: `coverage/` - ä»£ç¢¼è¦†è“‹ç‡åˆ†æå ±å‘Š

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js 15    â”‚    â”‚   OCPP Server   â”‚    â”‚   RabbitMQ      â”‚
â”‚   Frontend +    â”‚â—„â”€â”€â–ºâ”‚   WebSocket +   â”‚â—„â”€â”€â–ºâ”‚   Message       â”‚
â”‚   API Routes    â”‚    â”‚   REST API      â”‚    â”‚   Queue (æº–å‚™ä¸­) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â–¼â”€â”€â”€â”               â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
    â”‚Database â”‚              â”‚  EMS  â”‚               â”‚Events â”‚
    â”‚Services â”‚              â”‚Engine â”‚               â”‚System â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç•¶å‰æ¶æ§‹ç‰¹é»

- **å‰å¾Œç«¯åˆ†é›¢**: Next.js 15 æä¾›å‰ç«¯ UI + API Routesï¼ŒOCPP Server è™•ç†å”è­°é‚è¼¯
- **è³‡æ–™åº«æŠ½è±¡**: ä½¿ç”¨ Prisma ORM æ”¯æ´å¤šç¨®è³‡æ–™åº«ï¼Œçµ±ä¸€è³‡æ–™å­˜å–ä»‹é¢
- **WebSocket é€šè¨Š**: å¯¦ç¾å……é›»æ¨èˆ‡ä¼ºæœå™¨çš„å³æ™‚é›™å‘é€šè¨Š
- **EMS æ™ºèƒ½ç®¡ç†**: ä¸‰ç¨®è§¸ç™¼æ©Ÿåˆ¶ç¢ºä¿åŠŸç‡åˆ†é…çš„å³æ™‚æ€§å’Œæº–ç¢ºæ€§
- **äº‹ä»¶é©…å‹• (é€²è¡Œä¸­)**: RabbitMQ åŸºç¤è¨­æ–½å·²å°±ç·’ï¼Œæ­£åœ¨é€æ­¥æ•´åˆæ¥­å‹™é‚è¼¯

### EMS ç³»çµ±çµ„ä»¶

1. **Controllers** - æ¥­å‹™é‚è¼¯æ§åˆ¶å™¨
   - `emsController.js` - EMS ä¸»æ§åˆ¶å™¨ï¼Œè™•ç†åŠŸç‡åˆ†é…é‚è¼¯
   - `ocppController.js` - OCPP å”è­°è™•ç†å’Œæ¶ˆæ¯è·¯ç”±

2. **Services** - æ ¸å¿ƒæœå‹™å±¤
   - `emsService.js` - EMS èƒ½æºç®¡ç†æœå‹™ï¼Œå¯¦ç¾åˆ†é…æ¼”ç®—æ³•
   - `ocppMessageService.js` - OCPP æ¶ˆæ¯è™•ç†ï¼Œæ”¯æ´æ‰€æœ‰å”è­°æ¶ˆæ¯é¡å‹
   - `connectionService.js` - WebSocket é€£æ¥ç®¡ç†å’Œç‹€æ…‹ç¶­è­·
   - `chargeEventService.js` - å……é›»äº‹ä»¶è™•ç†å’Œç‹€æ…‹æ›´æ–°

3. **Event System** - äº‹ä»¶é©…å‹•ç³»çµ± (åˆæ­¥æ•´åˆéšæ®µ)
   - `ocppEventConsumer.js` - OCPP äº‹ä»¶æ¶ˆè²»è€…æ¡†æ¶
   - `emsEventConsumer.js` - EMS äº‹ä»¶æ¶ˆè²»è€…æ¡†æ¶  
   - `ocppEventPublisher.js` - äº‹ä»¶ç™¼å¸ƒæ©Ÿåˆ¶
   - `mqService.js` - æ¶ˆæ¯éšŠåˆ—åŸºç¤æœå‹™

4. **Data Layer** - è³‡æ–™å­˜å–å±¤
   - `chargePointRepository.js` - å……é›»æ¨è³‡æ–™å­˜å–å’Œæ¥­å‹™é‚è¼¯
   - `databaseService.js` - çµ±ä¸€è³‡æ–™åº«æœå‹™ä»‹é¢
   - Prisma ORM - å¤šè³‡æ–™åº«æ”¯æ´å’Œé¡å‹å®‰å…¨

## âš ï¸ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **è³‡æ–™åº«é€£æ¥éŒ¯èª¤**
   - æª¢æŸ¥ `.env` æ–‡ä»¶ä¸­çš„è³‡æ–™åº« URL æ˜¯å¦æ­£ç¢º
   - ç¢ºä¿è³‡æ–™åº«æœå‹™æ­£åœ¨é‹è¡Œ
   - é‹è¡Œ `npm run db:init` åˆå§‹åŒ–è³‡æ–™åº«

2. **OCPP ä¼ºæœå™¨ç„¡æ³•å•Ÿå‹•**
   - æª¢æŸ¥ç«¯å£ 8089 æ˜¯å¦è¢«ä½”ç”¨ï¼š`netstat -an | findstr 8089`
   - ç¢ºä¿æ‰€æœ‰ä¾è³´å·²å®‰è£ï¼š`npm install`
   - æª¢æŸ¥ RabbitMQ æ˜¯å¦æ­£åœ¨é‹è¡Œ

3. **RabbitMQ é€£æ¥å¤±æ•—**
   - **æ³¨æ„**: ç›®å‰ MQ ç‚ºå¯é¸åŠŸèƒ½ï¼Œå»ºè­°é–‹ç™¼éšæ®µè¨­å®š `MQ_ENABLED=false`
   - å¦‚éœ€æ¸¬è©¦ MQ åŠŸèƒ½ï¼š
     - ç¢ºèª RabbitMQ æœå‹™ç‹€æ…‹ï¼š`rabbitmq-diagnostics status`
     - æª¢æŸ¥é˜²ç«ç‰†è¨­å®šï¼Œç¢ºä¿ç«¯å£ 5672 å’Œ 15672 é–‹æ”¾
     - é©—è­‰é€£æ¥åƒæ•¸ï¼šä¸»æ©Ÿã€ç«¯å£ã€ç”¨æˆ¶åã€å¯†ç¢¼
     - æª¢æŸ¥ Docker å®¹å™¨ç‹€æ…‹ï¼š`docker ps | grep rabbitmq`

4. **EMS ç³»çµ±ç„¡éŸ¿æ‡‰**
   - æª¢æŸ¥ EMS å®šæ™‚æ ¡æ­£æ˜¯å¦å•Ÿå‹•ï¼šæŸ¥çœ‹æ—¥èªŒä¸­çš„å®šæ™‚å™¨æ¶ˆæ¯
   - é©—è­‰äº‹ä»¶é©…å‹•æ©Ÿåˆ¶ï¼šæŸ¥çœ‹ StatusNotificationã€StartTransaction ç­‰äº‹ä»¶è™•ç†
   - æª¢æŸ¥è³‡æ–™åº«é€£æ¥ï¼š`npm run db:init` æ¸¬è©¦è³‡æ–™åº«é€£æ¥
   - æŸ¥çœ‹ç³»çµ±ç‹€æ…‹ï¼š`GET /system/status`

5. **MQ ç›¸é—œå•é¡Œ (å¦‚æœå•Ÿç”¨)**
   - æª¢æŸ¥æ¶ˆæ¯éšŠåˆ—é€£æ¥ç‹€æ…‹ï¼š`GET /mq/health`
   - æŸ¥çœ‹ MQ ç®¡ç†ä»‹é¢ï¼šhttp://localhost:15672 (guest/guest)
   - æª¢æŸ¥äº‹ä»¶ç™¼å¸ƒè€…ç‹€æ…‹ï¼šæŸ¥çœ‹æ—¥èªŒä¸­çš„ç™¼å¸ƒæ¶ˆæ¯

5. **å‰ç«¯ç„¡æ³•è¼‰å…¥**
   - ç¢ºèª Next.js é–‹ç™¼ä¼ºæœå™¨æ­£åœ¨é‹è¡Œï¼š`npm run dev`
   - æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
   - é©—è­‰ API ç«¯é»æ˜¯å¦å¯è¨ªå•ï¼š`curl http://localhost:3000/api`
   - ç¢ºèªç’°å¢ƒè®Šæ•¸ `NEXT_PUBLIC_API_URL` è¨­å®šæ­£ç¢º

6. **è³‡æ–™åº«ç›¸é—œå•é¡Œ**
   - æ¸¬è©¦è³‡æ–™åº«é€£æ¥ï¼š`node scripts/test-db-connection.js`
   - æª¢æŸ¥ Prisma å®¢æˆ¶ç«¯ï¼š`node scripts/test-prisma.js`
   - é‡æ–°ç”Ÿæˆå®¢æˆ¶ç«¯ï¼š`npm run db:generate`
   - æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒå’Œé€£æ¥æ± ç‹€æ…‹

7. **æ¸¬è©¦å¤±æ•—**
   - ç¢ºä¿æ‰€æœ‰ä¾è³´å·²å®‰è£ï¼š`npm install`
   - æª¢æŸ¥è³‡æ–™åº«é€£æ¥å’Œæ¸¬è©¦è³‡æ–™
   - é‹è¡Œç‰¹å®šæ¸¬è©¦ï¼š`npm test tests/emsAllocator.test.js`
   - æ¸…ç†æ¸¬è©¦ç’°å¢ƒå¾Œé‡æ–°é‹è¡Œ

### é™¤éŒ¯æŠ€å·§

```bash
# æª¢æŸ¥æœå‹™ç‹€æ…‹
curl http://localhost:8089/health
curl http://localhost:8089/system/status

# æŸ¥çœ‹åœ¨ç·šå……é›»æ¨
curl http://localhost:8089/api/v1/chargepoints/online

# æ‰‹å‹•è§¸ç™¼ EMS é‡åˆ†é…
curl -X POST http://localhost:8089/ocpp/api/trigger_profile_update \
     -H "Content-Type: application/json" \
     -d '{"source":"debug"}'

# æª¢æŸ¥ RabbitMQ ç®¡ç†ç•Œé¢ (å¦‚æœå•Ÿç”¨)
# http://localhost:15672 (guest/guest)
```

å¦‚æœé‡åˆ°å…¶ä»–å•é¡Œï¼Œè«‹æª¢æŸ¥ `docs/` ç›®éŒ„ä¸‹çš„æ–‡ä»¶æˆ–æäº¤ Issueã€‚

## ğŸš€ éƒ¨ç½²

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

1. **Next.js å‰ç«¯éƒ¨ç½²**
   ```bash
   # å»ºæ§‹ç”Ÿç”¢ç‰ˆæœ¬
   npm run build
   
   # å•Ÿå‹•ç”Ÿç”¢ä¼ºæœå™¨
   npm run start
   ```
   
   æ¨è–¦éƒ¨ç½²å¹³å°ï¼š[Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme)

2. **OCPP å¾Œç«¯æœå‹™éƒ¨ç½²**
   ```bash
   # åŒæ™‚å•Ÿå‹•å‰ç«¯å’Œå¾Œç«¯
   npm run start:prod
   
   # æˆ–åˆ†åˆ¥éƒ¨ç½²
   npm run start         # Next.js
   npm run start:ocpp    # OCPP Server
   ```

3. **Docker éƒ¨ç½²** (æ¨è–¦)
   ```dockerfile
   # å»ºç«‹ Dockerfile
   FROM node:18-alpine
   WORKDIR /app
   COPY package*.json ./
   RUN npm ci --only=production
   COPY . .
   RUN npm run build
   EXPOSE 3000 8089
   CMD ["npm", "run", "start:prod"]
   ```

4. **ç’°å¢ƒè®Šæ•¸è¨­å®š**
   - ç”Ÿç”¢ç’°å¢ƒè«‹ç¢ºä¿è¨­å®šæ­£ç¢ºçš„è³‡æ–™åº«é€£æ¥
   - é…ç½® RabbitMQ é›†ç¾¤ä»¥æé«˜å¯ç”¨æ€§
   - è¨­å®šé©ç•¶çš„æ—¥èªŒç´šåˆ¥å’Œç›£æ§

æŸ¥çœ‹ [Next.js éƒ¨ç½²æ–‡ä»¶](https://nextjs.org/docs/app/building-your-application/deploying) ä»¥ç²å–æ›´å¤šè©³ç´°è³‡è¨Šã€‚

## è²¢ç»

æ­¡è¿ä»»ä½•å½¢å¼çš„è²¢ç»ï¼å¦‚æœä½ æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œè«‹éš¨æ™‚æå‡ºã€‚

### è²¢ç»æŒ‡å—

1. Fork æ­¤å°ˆæ¡ˆ
2. å»ºç«‹åŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. é–‹å•Ÿ Pull Request

## æˆæ¬Š

æœ¬å°ˆæ¡ˆæ¡ç”¨ MIT æˆæ¬Šæ¢æ¬¾ã€‚è©³è¦‹ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è¯ç¹«è³‡è¨Š

å¦‚æœæ‚¨æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œè«‹é€éä»¥ä¸‹æ–¹å¼è¯ç¹«ï¼š

-   é›»å­éƒµä»¶: your-email@example.com
-   GitHub Issues: [å°ˆæ¡ˆ Issues](https://github.com/your-username/csms-nextjs/issues)

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
csms-nextjs/
â”œâ”€â”€ .env.example              # ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
â”œâ”€â”€ eslint.config.mjs          # ESLint é…ç½®
â”œâ”€â”€ next.config.ts            # Next.js é…ç½®
â”œâ”€â”€ package.json              # å°ˆæ¡ˆä¾è³´å’Œè…³æœ¬
â”œâ”€â”€ postcss.config.mjs        # PostCSS é…ç½®
â”œâ”€â”€ tsconfig.json             # TypeScript é…ç½®
â”œâ”€â”€ coverage/                 # æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
â”œâ”€â”€ docs/                     # å°ˆæ¡ˆæ–‡ä»¶
â”‚   â””â”€â”€ EMS_MODE.md           # EMS æ¨¡å¼èªªæ˜æ–‡æª”
â”œâ”€â”€ test-results/             # EMS æ¸¬è©¦åŸ·è¡Œçµæœ
â”‚   â”œâ”€â”€ ems-test-report-*.md  # è©³ç´°æ¸¬è©¦å ±å‘Š
â”‚   â””â”€â”€ performance-*.json    # æ•ˆèƒ½åˆ†ææ•¸æ“š
â”œâ”€â”€ prisma/                   # Prisma è³‡æ–™åº«æ¨¡å¼å®šç¾©
â”‚   â”œâ”€â”€ schema.mssql.prisma   # MSSQL æ¨¡å¼
â”‚   â””â”€â”€ schema.prisma         # MySQL æ¨¡å¼
â”œâ”€â”€ prisma-clients/           # Prisma ç”Ÿæˆçš„å®¢æˆ¶ç«¯ (è‡ªå‹•ç”Ÿæˆ)
â”œâ”€â”€ public/                   # éœæ…‹è³‡æº (åœ–ç‰‡, SVG)
â”œâ”€â”€ scripts/                  # è¼”åŠ©è…³æœ¬
â”‚   â”œâ”€â”€ create-test-user.js   # å»ºç«‹æ¸¬è©¦ç”¨æˆ¶
â”‚   â”œâ”€â”€ hash-passwords.js     # å¯†ç¢¼é›œæ¹Šå·¥å…·
â”‚   â”œâ”€â”€ init-database.js      # è³‡æ–™åº«åˆå§‹åŒ–
â”‚   â”œâ”€â”€ run-ems-full-tests.bat # é‹è¡Œå®Œæ•´ EMS æ¸¬è©¦
â”‚   â”œâ”€â”€ run-ems-unit-tests.bat # é‹è¡Œå–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ test-db-connection.js # æ¸¬è©¦è³‡æ–™åº«é€£æ¥
â”‚   â””â”€â”€ test-prisma.js        # æ¸¬è©¦ Prisma é€£æ¥
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                  # Next.js 15 App Router é é¢å’Œ API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ api/              # RESTful API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ billing/      # è¨ˆè²»ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ cards/        # RFID å¡ç‰‡ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ charging_status/ # å……é›»ç‹€æ…‹ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/    # å„€è¡¨æ¿è³‡æ–™ API
â”‚   â”‚   â”‚   â”œâ”€â”€ database/     # è³‡æ–™åº«ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ login/        # èªè­‰ç›¸é—œ API
â”‚   â”‚   â”‚   â”œâ”€â”€ operation-logs/ # æ“ä½œæ—¥èªŒ API
â”‚   â”‚   â”‚   â”œâ”€â”€ session/      # æœƒè©±ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ users/        # ç”¨æˆ¶ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ wallet/       # éŒ¢åŒ…ç³»çµ± API
â”‚   â”‚   â”‚   â””â”€â”€ ... (å…¶ä»–æ¥­å‹™æ¨¡çµ„ API)
â”‚   â”‚   â”œâ”€â”€ charging_status/  # å……é›»ç‹€æ…‹ç›£æ§é é¢
â”‚   â”‚   â”œâ”€â”€ dashboard/        # ç³»çµ±å„€è¡¨æ¿é é¢
â”‚   â”‚   â”œâ”€â”€ database-management/ # è³‡æ–™åº«ç®¡ç†ä»‹é¢
â”‚   â”‚   â”œâ”€â”€ fault_report/     # æ•…éšœå ±å‘Šé é¢
â”‚   â”‚   â”œâ”€â”€ hardware_maintenance/ # ç¡¬é«”ç¶­è­·é é¢
â”‚   â”‚   â”œâ”€â”€ login/            # ç”¨æˆ¶ç™»å…¥é é¢
â”‚   â”‚   â”œâ”€â”€ operation_log/    # æ“ä½œæ—¥èªŒé é¢
â”‚   â”‚   â”œâ”€â”€ power_analysis/   # åŠŸç‡åˆ†æé é¢
â”‚   â”‚   â”œâ”€â”€ pricing_management/ # è²»ç‡ç®¡ç†é é¢
â”‚   â”‚   â”œâ”€â”€ reports/          # å ±è¡¨ä¸­å¿ƒé é¢
â”‚   â”‚   â”œâ”€â”€ security_log/     # å®‰å…¨æ—¥èªŒé é¢
â”‚   â”‚   â”œâ”€â”€ user_management/  # ç”¨æˆ¶ç®¡ç†é é¢
â”‚   â”‚   â””â”€â”€ ... (å…¶ä»–åŠŸèƒ½é é¢)
â”‚   â”œâ”€â”€ actions/              # Next.js Server Actions
â”‚   â”‚   â”œâ”€â”€ authActions.js    # èªè­‰ç›¸é—œå‹•ä½œ
â”‚   â”‚   â”œâ”€â”€ gunActions.js     # å……é›»æ§æ“ä½œå‹•ä½œ
â”‚   â”‚   â”œâ”€â”€ paymentActions.ts # æ”¯ä»˜ç›¸é—œå‹•ä½œ
â”‚   â”‚   â”œâ”€â”€ stationActions.js # å ´åŸŸç®¡ç†å‹•ä½œ
â”‚   â”‚   â”œâ”€â”€ tariffActions.ts  # è²»ç‡ç®¡ç†å‹•ä½œ
â”‚   â”‚   â””â”€â”€ userActions.ts    # ç”¨æˆ¶ç®¡ç†å‹•ä½œ
â”‚   â”œâ”€â”€ components/           # React å¯é‡ç”¨çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ cards/            # å¡ç‰‡çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ charts/           # åœ–è¡¨çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ common/           # é€šç”¨çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ dialog/           # å°è©±æ¡†çµ„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ CardManagementDialog.tsx # å¡ç‰‡ç®¡ç†å°è©±æ¡†
â”‚   â”‚   â”‚   â”œâ”€â”€ ResetPasswordDialog.tsx  # é‡è¨­å¯†ç¢¼å°è©±æ¡†
â”‚   â”‚   â”‚   â”œâ”€â”€ SiteDialog.tsx           # å ´åŸŸé¸æ“‡å°è©±æ¡†
â”‚   â”‚   â”‚   â””â”€â”€ UserDialog.tsx           # ç”¨æˆ¶ç·¨è¼¯å°è©±æ¡†
â”‚   â”‚   â”œâ”€â”€ layout/           # ä½ˆå±€çµ„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ Sidebar.tsx   # å´é‚Šæ¬„çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ navigation/       # å°èˆªçµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/               # åŸºç¤ UI çµ„ä»¶
â”‚   â”‚   â””â”€â”€ ... (å…¶ä»–çµ„ä»¶æ¨¡çµ„)
â”‚   â”œâ”€â”€ lib/                  # è¼”åŠ©å‡½å¼åº«å’Œå·¥å…·
â”‚   â”‚   â”œâ”€â”€ auth/             # èªè­‰ç›¸é—œ
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts       # èªè­‰å·¥å…·é¡
â”‚   â”‚   â”‚   â””â”€â”€ authMiddleware.ts # èªè­‰ä¸­ä»‹è»Ÿé«”
â”‚   â”‚   â”œâ”€â”€ database/         # è³‡æ–™åº«æœå‹™å±¤
â”‚   â”‚   â”‚   â”œâ”€â”€ adapter.js    # è³‡æ–™åº«é©é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware.js # è³‡æ–™åº«ä¸­ä»‹è»Ÿé«”
â”‚   â”‚   â”‚   â”œâ”€â”€ service.js    # çµ±ä¸€è³‡æ–™åº«æœå‹™ä»‹é¢
â”‚   â”‚   â”‚   â””â”€â”€ utils.js      # è³‡æ–™åº«å·¥å…·å‡½å¼
â”‚   â”‚   â”œâ”€â”€ services/         # æ¥­å‹™æœå‹™å±¤
â”‚   â”‚   â”‚   â””â”€â”€ billingService.js # è¨ˆè²»æœå‹™
â”‚   â”‚   â”œâ”€â”€ emsAllocator.js   # EMS æ ¸å¿ƒåˆ†é…æ¼”ç®—æ³•
â”‚   â”‚   â”œâ”€â”€ logger.js         # çµ±ä¸€æ—¥èªŒç®¡ç†
â”‚   â”‚   â”œâ”€â”€ operationLogger.ts # æ“ä½œæ—¥èªŒè¨˜éŒ„å™¨
â”‚   â”‚   â””â”€â”€ utils.js          # é€šç”¨å·¥å…·å‡½å¼
â”‚   â”œâ”€â”€ models/               # è³‡æ–™åº«æ¨¡å‹å®šç¾© (Sequelize)
â”‚   â””â”€â”€ servers/              # å¾Œç«¯å¾®æœå‹™æ¶æ§‹
â”‚       â”œâ”€â”€ config/           # æœå‹™é…ç½®ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ envConfig.js  # ç’°å¢ƒè®Šæ•¸é…ç½®
â”‚       â”‚   â””â”€â”€ mqConfig.js   # MQ æ¶ˆæ¯éšŠåˆ—é…ç½®
â”‚       â”œâ”€â”€ connectors/       # å¤–éƒ¨ç³»çµ±é€£æ¥å™¨  
â”‚       â”‚   â””â”€â”€ ocppMqConnector.js # OCPP-MQ æ©‹æ¥å™¨
â”‚       â”œâ”€â”€ consumers/        # MQ æ¶ˆæ¯æ¶ˆè²»è€… (åˆæ­¥æ•´åˆ)
â”‚       â”‚   â”œâ”€â”€ ocppEventConsumer.js # OCPP äº‹ä»¶æ¶ˆè²»è€…
â”‚       â”‚   â””â”€â”€ emsEventConsumer.js  # EMS äº‹ä»¶æ¶ˆè²»è€…
â”‚       â”œâ”€â”€ controllers/      # æ¥­å‹™é‚è¼¯æ§åˆ¶å™¨
â”‚       â”‚   â”œâ”€â”€ ocppController.js    # OCPP å”è­°ä¸»æ§åˆ¶å™¨
â”‚       â”‚   â””â”€â”€ emsController.js     # EMS èƒ½æºç®¡ç†æ§åˆ¶å™¨
â”‚       â”œâ”€â”€ publishers/       # MQ æ¶ˆæ¯ç™¼å¸ƒè€… (åˆæ­¥æ•´åˆ)
â”‚       â”‚   â”œâ”€â”€ ocppEventPublisher.js # OCPP äº‹ä»¶ç™¼å¸ƒ
â”‚       â”‚   â””â”€â”€ emsEventPublisher.js  # EMS äº‹ä»¶ç™¼å¸ƒ
â”‚       â”œâ”€â”€ repositories/     # è³‡æ–™å­˜å–å±¤ (Repository Pattern)
â”‚       â”‚   â””â”€â”€ chargePointRepository.js # å……é›»æ¨è³‡æ–™å­˜å–
â”‚       â”œâ”€â”€ services/         # æ ¸å¿ƒæ¥­å‹™æœå‹™å±¤
â”‚       â”‚   â”œâ”€â”€ emsService.js         # EMS èƒ½æºç®¡ç†æœå‹™
â”‚       â”‚   â”œâ”€â”€ ocppMessageService.js # OCPP æ¶ˆæ¯è™•ç†æœå‹™
â”‚       â”‚   â”œâ”€â”€ connectionService.js  # WebSocket é€£æ¥ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ mqService.js          # MQ åŸºç¤æœå‹™ (åˆæ­¥æ•´åˆ)
â”‚       â”‚   â”œâ”€â”€ chargeEventService.js # å……é›»äº‹ä»¶è™•ç†
â”‚       â”‚   â””â”€â”€ systemStatusService.js # ç³»çµ±ç‹€æ…‹ç›£æ§
â”‚       â”œâ”€â”€ utils/            # ä¼ºæœå™¨ç«¯å·¥å…·å‡½å¼
â”‚       â”‚   â”œâ”€â”€ logger.js     # ä¼ºæœå™¨æ—¥èªŒå·¥å…·
â”‚       â”‚   â””â”€â”€ helpers.js    # è¼”åŠ©å‡½å¼é›†åˆ
â”‚       â”œâ”€â”€ mqServer.js       # RabbitMQ ä¼ºæœå™¨åˆå§‹åŒ– (åˆæ­¥æ•´åˆ)
â”‚       â””â”€â”€ ocppServer.js     # OCPP WebSocket ä¼ºæœå™¨ä¸»å…¥å£
â”œâ”€â”€ tests/                    # æ¸¬è©¦æ–‡ä»¶
â”‚   â”œâ”€â”€ emsAllocator.test.js  # EMS æ¼”ç®—æ³•å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ emsConsistency.test.js # EMS ä¸€è‡´æ€§æ¸¬è©¦
â”‚   â””â”€â”€ emsIntegration.test.js # EMS æ•´åˆæ¸¬è©¦
â””â”€â”€ ... (å…¶ä»–è¨­å®šæª”)
```

### æ¶æ§‹èªªæ˜

- **å‰å¾Œç«¯åˆ†é›¢**: Next.js 15 App Router æä¾›ç¾ä»£åŒ–å‰ç«¯ + API Routesï¼ŒOCPP Server å°ˆè²¬å”è­°è™•ç†
- **åˆ†å±¤æ¶æ§‹**: Controllers â†’ Services â†’ Repositories â†’ Database æ¸…æ™°åˆ†å±¤
- **è³‡æ–™åº«æŠ½è±¡**: Prisma ORM æä¾›é¡å‹å®‰å…¨çš„è³‡æ–™å­˜å–ï¼Œæ”¯æ´å¤šè³‡æ–™åº«åˆ‡æ›
- **WebSocket ç®¡ç†**: ä¼æ¥­ç´š WebSocket é€£æ¥æ± ï¼Œæ”¯æ´å¤§è¦æ¨¡å……é›»æ¨åŒæ™‚æ¥å…¥
- **EMS æ™ºèƒ½å¼•æ“**: ä¸‰è§¸ç™¼æ©Ÿåˆ¶ + äº‹ä»¶é©…å‹•ï¼Œç¢ºä¿åŠŸç‡åˆ†é…çš„å³æ™‚æ€§å’Œæº–ç¢ºæ€§
- **äº‹ä»¶é©…å‹• (é€²è¡Œä¸­)**: RabbitMQ åŸºç¤è¨­æ–½å°±ç·’ï¼Œæ­£åœ¨é€æ­¥å°‡åŒæ­¥æ¥­å‹™é‚è¼¯é·ç§»è‡³éåŒæ­¥äº‹ä»¶æ¨¡å¼
- **æ¨¡çµ„åŒ–è¨­è¨ˆ**: é«˜å…§èšä½è€¦åˆçš„çµ„ä»¶è¨­è¨ˆï¼Œæ”¯æ´ç¨ç«‹é–‹ç™¼å’Œæ¸¬è©¦
- **å®Œæ•´çš„èªè­‰ç³»çµ±**: JWT èªè­‰ã€æ¬Šé™æ§åˆ¶ã€æ“ä½œæ—¥èªŒè¿½è¹¤
- **ç”¨æˆ¶ç®¡ç†ç³»çµ±**: ç®¡ç†å“¡/ç”¨æˆ¶åˆ†é›¢ã€RFID å¡ç‰‡ç¶å®šã€éŒ¢åŒ…ç³»çµ±

---

## ğŸ¯ å°ˆæ¡ˆé‡Œç¨‹ç¢‘

### âœ… å·²å®ŒæˆåŠŸèƒ½
- **OCPP 1.6 å”è­°**: å®Œæ•´å¯¦ç¾ WebSocket é€šè¨Šå’Œæ‰€æœ‰æ ¸å¿ƒæ¶ˆæ¯é¡å‹
- **EMS ä¸‰ç¨®è§¸ç™¼æ©Ÿåˆ¶**: æ‰‹å‹•ã€å®šæ™‚ã€äº‹ä»¶é©…å‹•å…¨éƒ¨å¯¦ç¾ä¸¦ç¶“æ¸¬è©¦é©—è­‰
- **æ™ºèƒ½åŠŸç‡åˆ†é…**: æ”¯æ´éœæ…‹/å‹•æ…‹æ¨¡å¼ï¼Œé›»è¡¨ç´šç²¾ç´°åŒ–ç®¡ç†
- **å¤šè³‡æ–™åº«æ”¯æ´**: MySQL/MSSQL é›™è³‡æ–™åº«æ¶æ§‹ï¼ŒPrisma ORM çµ±ä¸€ç®¡ç†
- **å®Œæ•´æ¸¬è©¦é«”ç³»**: 86.7% æ¸¬è©¦è¦†è“‹ç‡ï¼Œæ¶µè“‹å–®å…ƒæ¸¬è©¦ã€æ•´åˆæ¸¬è©¦ã€ä¸€è‡´æ€§æ¸¬è©¦
- **å‰ç«¯ç®¡ç†ç³»çµ±**: Next.js 15 éŸ¿æ‡‰å¼ä»‹é¢ï¼Œæ¶µè“‹å……é›»ç«™ç›£æ§ã€ç”¨æˆ¶ç®¡ç†ã€å ±è¡¨åˆ†æç­‰æ¨¡çµ„
- **ç”¨æˆ¶ç®¡ç†ç³»çµ±**: 
  - ç®¡ç†å“¡èˆ‡ä¸€èˆ¬ç”¨æˆ¶åˆ†é›¢ç®¡ç†
  - RFID å¡ç‰‡ç¶å®šèˆ‡ç®¡ç†
  - ç”¨æˆ¶éŒ¢åŒ…ç³»çµ± (å„²å€¼/æ‰£æ¬¾)
  - ç”¨æˆ¶æ¬Šé™æ§åˆ¶èˆ‡å¸³æˆ¶ç‹€æ…‹ç®¡ç†
  - å¯†ç¢¼é‡è¨­èˆ‡å¸³æˆ¶å®‰å…¨æ©Ÿåˆ¶
- **æ“ä½œæ—¥èªŒç³»çµ±**: å®Œæ•´çš„æ“ä½œè¿½è¹¤èˆ‡å¯©è¨ˆåŠŸèƒ½
- **è³‡æ–™åº«æ—¥èªŒå„ªåŒ–**: cp_logs è¡¨åƒ…è¨˜éŒ„ OCPP JSON æ¶ˆæ¯ï¼Œå„ªåŒ–å„²å­˜æ•ˆç‡
- **èªè­‰èˆ‡æˆæ¬Š**: JWT èªè­‰ã€æ¬Šé™ä¸­ä»‹è»Ÿé«”ã€æœƒè©±ç®¡ç†
- **è¨ˆè²»ç®¡ç†**: è²»ç‡è¨­å®šã€è¨ˆè²»æ¸ é“ç®¡ç†ã€äº¤æ˜“è¨˜éŒ„

### ğŸš§ æ­£åœ¨é–‹ç™¼
- **äº‹ä»¶é©…å‹•æ¶æ§‹å®Œæ•´æ•´åˆ**: RabbitMQ åŸºç¤è¨­æ–½å·²å»ºç«‹ï¼Œæ­£åœ¨å°‡æ ¸å¿ƒæ¥­å‹™é‚è¼¯é·ç§»è‡³äº‹ä»¶é©…å‹•æ¨¡å¼
- **æ•ˆèƒ½ç›£æ§å¢å¼·**: WebSocket é€£æ¥ç›£æ§ã€ç³»çµ±è³‡æºè¿½è¹¤ã€å‘Šè­¦æ©Ÿåˆ¶
- **OCPP 2.0.1 æ”¯æ´**: æ–°ç‰ˆå”è­°ç ”ç©¶å’Œå¯¦ç¾è¦åŠƒ
- **é€²éš EMS æ¼”ç®—æ³•**: åŸºæ–¼æ­·å²æ•¸æ“šçš„æ©Ÿå™¨å­¸ç¿’åŠŸç‡é æ¸¬å’Œå„ªåŒ–
- **æ”¯ä»˜ç³»çµ±æ•´åˆ**: ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£æ•´åˆ
- **è¡Œå‹•ç«¯æ‡‰ç”¨**: ç®¡ç†å“¡è¡Œå‹•æ‡‰ç”¨é–‹ç™¼

### ğŸ“‹ è¦åŠƒåŠŸèƒ½
- **å®¹å™¨åŒ–éƒ¨ç½²**: Docker å’Œ Kubernetes éƒ¨ç½²æ–¹æ¡ˆ
- **é«˜å¯ç”¨æ€§æ¶æ§‹**: è² è¼‰å‡è¡¡ã€æ•…éšœåˆ‡æ›ã€è³‡æ–™å‚™ä»½ç­–ç•¥
- **ç›£æ§å’Œå‘Šè­¦**: Prometheus + Grafana ç›£æ§é«”ç³»
- **API æ–‡æª”**: Swagger/OpenAPI è‡ªå‹•ç”Ÿæˆæ–‡æª”
- **åœ‹éš›åŒ–æ”¯æ´**: å¤šèªè¨€ç•Œé¢æ”¯æŒ
- **é€²éšå ±è¡¨**: è‡ªå®šç¾©å ±è¡¨ç”Ÿæˆå™¨

### ğŸ“Š ç³»çµ±æŒ‡æ¨™
- **API å›æ‡‰æ™‚é–“**: < 100ms (å¹³å‡)
- **WebSocket é€£æ¥**: æ”¯æ´ 1000+ å……é›»æ¨åŒæ™‚åœ¨ç·š
- **EMS éŸ¿æ‡‰æ™‚é–“**: æ¯«ç§’ç´šäº‹ä»¶è™•ç†
- **è³‡æ–™åº«æ•ˆèƒ½**: æ”¯æ´é«˜ä½µç™¼è®€å¯«æ“ä½œ
- **ç³»çµ±å¯ç”¨æ€§**: 99.5+ (æ¸¬è©¦ç’°å¢ƒ)
- **æ¸¬è©¦è¦†è“‹ç‡**: 86.7% (EMS æ ¸å¿ƒæ¨¡çµ„)
- **ç”¨æˆ¶ä¸¦ç™¼**: æ”¯æ´ 100+ ç®¡ç†å“¡åŒæ™‚æ“ä½œ

**æŠ€è¡“ç‰¹é»**:
- åŸºæ–¼ Node.js 18+ å’Œ Next.js 15 çš„ç¾ä»£åŒ–æŠ€è¡“æ£§
- TypeScript æ”¯æ´ï¼Œæä¾›å®Œæ•´çš„é¡å‹å®‰å…¨
- Prisma ORM å¯¦ç¾è³‡æ–™åº«ç„¡é—œçš„é–‹ç™¼é«”é©—  
- WebSocket é•·é€£æ¥ç®¡ç†ï¼Œæ”¯æ´å¤§è¦æ¨¡å……é›»æ¨æ¥å…¥
- äº‹ä»¶é©…å‹•æ¶æ§‹è¨­è¨ˆï¼Œç‚ºæœªä¾†æ“´å±•å¥ å®šåŸºç¤

**æ³¨æ„**: MQ äº‹ä»¶é©…å‹•æ¶æ§‹ç›®å‰ç‚ºåˆæ­¥æ¥å…¥éšæ®µï¼Œä¸»è¦æ¥­å‹™é‚è¼¯ä»åœ¨å‚³çµ±åŒæ­¥æ¨¡å¼ä¸‹é‹è¡Œã€‚å»ºè­°é–‹ç™¼éšæ®µä½¿ç”¨ `MQ_ENABLED=false` ä»¥ç¢ºä¿ç³»çµ±ç©©å®šæ€§ã€‚

---

## ğŸ”„ RabbitMQ æ•´åˆç‹€æ…‹

### ç›®å‰é€²åº¦
- âœ… **åŸºç¤è¨­æ–½**: MQ é€£æ¥ã€äº¤æ›æ©Ÿã€éšŠåˆ—é…ç½®å®Œæˆ
- âœ… **ç™¼å¸ƒè€…æ¡†æ¶**: OCPP å’Œ EMS äº‹ä»¶ç™¼å¸ƒæ©Ÿåˆ¶å¯¦ç¾
- âœ… **æ¶ˆè²»è€…æ¡†æ¶**: äº‹ä»¶æ¶ˆè²»è€…çµæ§‹å»ºç«‹
- âœ… **é…ç½®ç®¡ç†**: å®Œæ•´çš„ MQ é…ç½®å’Œç’°å¢ƒè®Šæ•¸æ”¯æ´
- ğŸš§ **æ¥­å‹™æ•´åˆ**: æ­£åœ¨å°‡æ ¸å¿ƒé‚è¼¯å¾åŒæ­¥è½‰ç‚ºäº‹ä»¶é©…å‹•æ¨¡å¼

### é–‹ç™¼å»ºè­°
1. **ç›®å‰é–‹ç™¼**: ä½¿ç”¨ `MQ_ENABLED=false`ï¼Œä¾è³´ç¾æœ‰åŒæ­¥é‚è¼¯
2. **MQ æ¸¬è©¦**: è¨­å®š `MQ_ENABLED=true` æ¸¬è©¦äº‹ä»¶ç™¼å¸ƒ/æ¶ˆè²»åŠŸèƒ½  
3. **ç”Ÿç”¢éƒ¨ç½²**: å¾…æ¥­å‹™é‚è¼¯å®Œå…¨æ•´åˆå¾Œå†å•Ÿç”¨ MQ æ¨¡å¼

### ç›¸é—œæª”æ¡ˆ
- **é…ç½®**: `src/servers/config/mqConfig.js`
- **æœå‹™**: `src/servers/services/mqService.js`
- **ç™¼å¸ƒè€…**: `src/servers/publishers/`
- **æ¶ˆè²»è€…**: `src/servers/consumers/`
- **é€£æ¥å™¨**: `src/servers/mqServer.js`

---

**æŒçºŒæ›´æ–°**: æœ¬å°ˆæ¡ˆç©æ¥µé–‹ç™¼ä¸­ï¼ŒREADME å°‡éš¨åŠŸèƒ½é€²å±•åŒæ­¥æ›´æ–°ã€‚

ğŸ“§ **æŠ€è¡“æ”¯æ´**: å¦‚æœ‰å•é¡Œè«‹é€é GitHub Issues æˆ–è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚
