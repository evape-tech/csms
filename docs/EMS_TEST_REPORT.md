# EMS 分配演算法測試報告

## 測試概要

**執行時間**: 2024年執行  
**測試框架**: Jest  
**測試檔案**: `tests/emsAllocator.test.js`  
**目標檔案**: `src/lib/emsAllocator.js`  

## 測試結果

✅ **11個測試案例全數通過**

### 測試覆蓋率
- **程式碼行覆蓋率**: 100% 
- **函式覆蓋率**: 100%
- **分支覆蓋率**: 77.77%
- **語句覆蓋率**: 100%

## 測試案例明細

### 1. isCharging 函式測試
- ✅ 正確識別各種充電狀態（Charging、InUse、Available等）

### 2. Case 1 — 靜態模式（容量足夠）
- ✅ 3台AC 7kW，場域50kW，按規格分配
- **驗證結果**: 每台31A (6.82kW)，總分配20.46kW

### 3. Case 2 — 靜態模式（超載，比例縮放）
- ✅ 3台AC 7kW，場域10kW，按比例分配
- **驗證結果**: 每台15A (3.3kW)，總分配9.9kW，接近場域限制

### 4. Case 3 — 動態模式（無槍充電，回退靜態）
- ✅ 所有槍均非charging，回退static行為
- **驗證結果**: 回退至靜態模式，結果與Case1相同

### 5. Case 4 — 動態模式（部分充電，需求≤最大值）
- ✅ 4台AC，2台charging，charging槍給full spec，其餘最小值
- **驗證結果**: 充電槍31A，非充電槍6A

### 6. Case 5 — 動態模式（充電過載，比例分配）
- ✅ 3台AC，2台charging，charging需求超載按比例分配
- **驗證結果**: 充電槍22A (5kW)，非充電槍6A

### 7. Case 6 — DC分配（AC優先，DC取剩餘）
- ✅ 3台DC各360kW，場域1080kW，純DC場域
- **驗證結果**: 每台360000W (360kW)，總分配1080kW

### 8. Case 7 — 11kW AC上限截斷
- ✅ 單台11kW AC，截斷至48A上限
- **驗證結果**: 限制為48A (10.56kW)而非計算值50A

### 9. Case 8 — 動態模式混合AC/DC分配
- ✅ AC charging + DC charging，測試混合分配
- **驗證結果**: AC充電槍full spec，DC分配剩餘功率，非充電槍最小值

### 10. 邊界條件測試 — AC最小值限制
- ✅ 分配值<6A應補正為6A
- **驗證結果**: 極小場域下AC最小值補正生效

### 11. 邊界條件測試 — DC最小值限制
- ✅ 分配值≤0應補正為1000W
- **驗證結果**: 場域功率為0時DC最小值補正生效

## 關鍵演算法驗證

### 靜態模式 (Static Mode)
- ✅ AC需求計算正確: `Σ(max_kw)`
- ✅ 比例縮放計算正確: `ratio = max_power_kw / total_demand`
- ✅ 電流轉換正確: `A = floor(kW * 1000 / 220)`
- ✅ DC剩餘功率分配正確: `available_dc = max_power_kw - actual_ac`

### 動態模式 (Dynamic Mode)
- ✅ 充電狀態檢測正確: `isCharging(guns_status)`
- ✅ 充電槍優先分配正確
- ✅ 非充電槍最小值分配正確
- ✅ 無充電槍時回退static正確

### 限制應用 (Limits Application)
- ✅ AC最小值6A生效
- ✅ AC 11kW上限48A生效  
- ✅ DC最小值1000W生效
- ✅ 功率單位轉換正確 (kW ↔ A ↔ W)

## 數學計算驗證

### 功率轉換公式
- AC: `P(kW) = I(A) × 220V / 1000`
- DC: `P(kW) = P(W) / 1000`

### 比例分配公式
- `ratio = available_power / total_demand`
- `allocated_power = original_power × ratio`

### 限制邊界
- AC電流: `6A ≤ I ≤ 48A` (11kW樁)
- DC功率: `P ≥ 1000W`

## 整合性測試

所有測試案例完整覆蓋了EMS分配演算法的：
1. **靜態/動態模式切換邏輯**
2. **AC/DC混合分配策略**  
3. **功率超載處理機制**
4. **充電狀態識別邏輯**
5. **邊界條件與限制應用**
6. **數學計算精度驗證**

## 測試結論

✅ **EMS分配演算法已通過完整的測試驗證並成功整合到系統中**
- 所有核心功能正常運作
- 邊界條件處理正確
- 數學計算精度符合預期
- 程式碼覆蓋率達標（100%行覆蓋）
- **已成功整合到 ocppController.js**

## 整合完成狀態

### ✅ 完成項目
1. **純函式提取** - `src/lib/emsAllocator.js` 包含完整 EMS 演算法
2. **單元測試** - 11個測試案例，100%程式碼覆蓋率
3. **一致性驗證** - 8個測試確保新舊邏輯一致
4. **整合實作** - 已將純函式整合回 `src/servers/ocppController.js`
5. **整合測試** - 7個測試驗證整合後的 OCPP 功能

### 📊 完整測試統計
- **總測試案例**: 26個測試 (11個單元測試 + 8個一致性測試 + 7個整合測試)
- **測試結果**: 100% 通過率
- **程式碼覆蓋率**: 100% 行覆蓋率, 100% 函式覆蓋率

### 🔧 技術實作
- **架構**: 純函式設計，完全可測試
- **整合方式**: 在 `ocpp_send_command` 中調用 `calculateEmsAllocation`
- **相容性**: 保持 OCPP 訊息格式完全相容
- **效能**: 單次計算所有分配，避免重複運算

純函式設計使得EMS邏輯完全可測試，確保在各種場域配置和充電狀態下都能正確分配電力資源。**整合已完成，系統可安全投入生產使用。**
