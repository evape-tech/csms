# Caddyfile - Caddy 配置文件
# 更多配置選項: https://caddyserver.com/docs/caddyfile

{
    # 讓 Admin API 可以從外部訪問
    admin 0.0.0.0:2019
}

# ============================================
# 本地開發 + Cloudflare Tunnel 統一配置
# ============================================

# HTTP 配置 (端口 80)
:80 {
    # Next.js Web 服務
    reverse_proxy web:3000 {
        # 傳遞真實客戶端 IP 和協議信息 (Cloudflare Tunnel 需要)
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up Host {host}
    }
    
    # 訪問日誌
    log {
        output file /var/log/caddy/http-access.log
    }
}

# HTTPS 配置 (端口 443) - localhost 自簽名證書
localhost:443 {
    # 使用 Caddy 內建的本地 CA (自簽名證書)
    tls internal
    
    # Next.js Web 服務
    reverse_proxy web:3000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto https
        header_up Host {host}
    }
    
    # 訪問日誌
    log {
        output file /var/log/caddy/https-access.log
    }
}

