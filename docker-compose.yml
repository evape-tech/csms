version: '3.8'

services:
  caddy:
    image: caddy:latest
    container_name: csms-caddy
    restart: always
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "2019:2019"  # Caddy Admin API
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
      - ocpp
    networks:
      - csms-network

  caddy-ui:
    image: qmcgaw/caddy-ui:latest
    container_name: csms-caddy-ui
    restart: always
    ports:
      - "8888:8000"  # Caddy UI
    environment:
      - CADDY_API_ENDPOINT=http://caddy:2019
      - ROOT_URL=/
    depends_on:
      - caddy
    networks:
      - csms-network

  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: csms-web
    restart: always
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: node server.js
    networks:
      - csms-network

  ocpp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: csms-ocpp
    restart: always
    # 保留 8089 用於開發/測試,生產環境可通過 Caddy 443 訪問
    ports:
      - "8089:8089"
    expose:
      - "8089"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: npm run start:ocpp:prod
    networks:
      - csms-network

networks:
  csms-network:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
